# push-service

校验：
结合jwt，确保是合法用户
单点登录（账号登录时生成session放在jwt里，每次新增登录时会新创建一个session，替换掉之前的，调用接口时会校验session）
校验session是否合法，然后觉得是否要连接或者断开ws

获取用户在线状态

获取用户产生的消息，推送至其他服务

推送其他服务发送的消息给用户
两种情况 在线和不在线

1. WebSocket 服务模块（连接管理）
   •	监听并接受 WebSocket 连接
   •	每个连接关联一个 userID
   •	管理连接生命周期（上线/下线）
2. 2. 在线状态存储模块
      •	记录当前所有在线用户
      •	提供增删查在线状态的能力
      •	可实现为内存+Redis混合（单机时用内存
3. 3. 状态查询接口模块
      •	提供 GetOnlineStatus(userID) 接口
      •	供其他服务调用（如好友列表显示在线状态

---

# 推送服务设计说明（详细）

推送服务用于管理客户端 WebSocket 连接、获取用户在线状态、并将其他服务的消息推送至客户端。

## ✅ 功能概述

1. WebSocket 连接管理（单端登录、心跳保活）
2. 在线状态记录（内存+Redis混合）
3. 在线状态查询接口（供其他服务调用）
4. 消息接收与下发（在线/离线处理）

## 🔐 鉴权机制

- 使用 JWT 校验用户身份
- 支持单点登录：
  - 每次登录会创建一个新的 session 并存入 JWT
  - WebSocket 建立连接时会校验当前 session 是否为最新
  - 若不是最新 session，服务器主动断开连接

## 📦 模块划分

### 1. WebSocket 服务模块（连接管理）
- 监听并接受 WebSocket 连接
- 每个连接绑定一个 userID
- 单用户单连接（不支持多端）
- 管理连接生命周期（上线/下线）
- 心跳机制维护连接活性，断线自动清除状态(只实现断线清除，客户端会有心跳)

### 2. 在线状态存储模块
- 记录所有当前在线的用户
- 提供添加、删除、查询用户状态的能力
- 实现方式：
  - 单机模式：使用 `sync.Map` 存储在线用户
  - 多实例部署：使用 Redis 存储状态（支持共享）

### 3. 状态查询接口模块
- 提供 `GetOnlineStatus(userID)` 接口
- 实现为 gRPC 接口
- 供其他服务调用（例如好友服务获取好友在线状态）

## 📤 消息推送流程

- 接收其他服务发来的消息
- 判断用户是否在线：
  - 若在线，尝试通过 WebSocket 发送
  - 若发送失败或用户不在线，触发离线消息存储逻辑（如存入 Redis 或 DB）